<!DOCTYPE html>
<html lang="th">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>เส้นทางไปศูนย์บริการ</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.7.1/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.7.1/dist/leaflet.js"></script>
    <script src="https://unpkg.com/leaflet-routing-machine/dist/leaflet-routing-machine.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Kanit:wght@300;400;600&display=swap" rel="stylesheet">
    <style>
        /* ใช้ฟอนต์ Kanit จาก Google Fonts */
        body {
            font-family: 'Kanit', sans-serif;
            background-color: #f4f6f9;
            margin: 0;
            padding: 0;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: flex-start;
            min-height: 100vh;
        }

        /* กำหนดความกว้างและระยะห่างของ map */
        h1 {
            font-size: 2.5rem;
            color: #2c3e50;
            margin-bottom: 20px;
            text-align: center;
        }

        /* Container เพื่อให้แผนที่และการ์ดอยู่ในแนวนอน */
        .container {
            display: flex;
            justify-content: center;
            align-items: flex-start;
            margin-top: 30px;
            width: 100%;
            max-width: 1200px;
        }

        /* แผนที่ */
        #map {
            height: 500px;
            width: 48%;
            /* ปรับให้แผนที่มีความกว้างครึ่งหนึ่ง */
            max-width: 800px;
            border-radius: 10px;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.1);
            margin-right: 20px;
            /* เพิ่มระยะห่างจากการ์ด */
        }

        /* กำหนดการ์ด */
        .card {
            background-color: #fff;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.1);
            max-width: 400px;
            /* ขนาดการ์ดที่เหมาะสม */
        }

        /* ข้อความภายในการ์ด */
        .card h2 {
            color: #2980b9;
            font-size: 1.5rem;
        }

        .card p {
            color: #34495e;
            font-size: 1rem;
            margin: 10px 0;
        }

        /* ปุ่ม */
        .button {
            background-color: #2980b9;
            color: white;
            padding: 10px 20px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 1rem;
            transition: background-color 0.3s;
        }

        .button:hover {
            background-color: #3498db;
        }

        /* Footer */
        footer {
            margin-top: 40px;
            font-size: 1rem;
            color: #7f8c8d;
        }

        footer a {
            color: #3498db;
            text-decoration: none;
        }

        footer a:hover {
            text-decoration: underline;
        }
    </style>
</head>

<body>

    <h1>เส้นทางไปศูนย์บริการ</h1>

    <div class="container">
        <div id="map"></div>

        <div class="card">
            <h2>ศูนย์บริการที่ใกล้ที่สุด</h2>
            <p id="service-name">กำลังค้นหาศูนย์บริการ...</p>
            <p id="service-address">ที่อยู่: กำลังค้นหา...</p>
            <p id="service-phone">เบอร์โทร: กำลังค้นหา...</p>
            <p id="service-code">หมายเลขศูนย์บริการ: กำลังค้นหา...</p> <!-- เพิ่มสำหรับหมายเลขศูนย์บริการ -->
            <p id="service-bus-stops">ป้ายรถเมล์: กำลังค้นหา...</p> <!-- เพิ่มสำหรับป้ายรถเมล์ -->
            <p id="service-opening-time">เวลาเปิดทำการ: กำลังค้นหา...</p> <!-- เพิ่มสำหรับเวลาเปิดทำการ -->
            <button class="button" onclick="reloadPage()">โหลดใหม่</button>
        </div>

    </div>

    <footer>
        <p>Powered by <a href="https://www.openrouteservice.org" target="_blank">OpenRouteService</a></p>
    </footer>

    <script>
        navigator.geolocation.watchPosition(
            function (position) {
                var userLocation = [position.coords.latitude, position.coords.longitude];

                console.log('ตำแหน่งผู้ใช้ที่ได้รับ: ', userLocation);

                var map = L.map('map').setView(userLocation, 13);  // ใช้ตำแหน่งที่ได้รับเพื่อกำหนดแผนที่

                L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                    attribution: '© OpenStreetMap contributors'
                }).addTo(map);


                fetch('/get_location', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ latitude: userLocation[0], longitude: userLocation[1] })
                })
                    .then(response => response.json())
                    .then(data => {
                        if (!data.closest_center || !data.route) {
                            alert("ไม่สามารถหาศูนย์บริการที่ใกล้ที่สุดหรือเส้นทางได้");
                            return;
                        }

                        var centerLat = data.closest_center.lat;
                        var centerLng = data.closest_center.lng;

                        if (isNaN(centerLat) || isNaN(centerLng)) {
                            alert("พิกัดของศูนย์บริการไม่ถูกต้อง");
                            return;
                        }

                        var routeCoordinates = data.route.map(function (coord) {
                            return [coord[1], coord[0]];  // แปลงจาก [lon, lat] เป็น [lat, lon]
                        });

                        var centerLocation = [centerLat, centerLng];

                        L.circleMarker(userLocation, {
                            color: 'red',
                            radius: 8,
                            fillColor: 'red',
                            fillOpacity: 1
                        })
                            .addTo(map)
                            .bindPopup('คุณอยู่ที่นี่')
                            .openPopup();

                        // สร้าง CircleMarker สำหรับศูนย์บริการ (สีน้ำเงิน)
                        L.circleMarker(centerLocation, {
                            color: 'blue',
                            radius: 8,
                            fillColor: 'blue',
                            fillOpacity: 1
                        })
                            .addTo(map)
                            .bindPopup('ศูนย์บริการที่ใกล้ที่สุด');

                            
                        // ใช้ L.polyline เพื่อแสดงเส้นทาง
                        L.polyline(routeCoordinates, { color: 'blue' }).addTo(map);

                        // แสดงข้อมูลศูนย์บริการในหน้าเว็บ
                        document.getElementById('service-name').innerText = "ชื่อ: " + data.service_info.name;
                        document.getElementById('service-address').innerText = "ที่อยู่: " + data.service_info.address;
                        document.getElementById('service-phone').innerText = "เบอร์โทร: " + data.service_info.phone;

                        // แสดงข้อมูลเพิ่มเติมจาก service_info
                        document.getElementById('service-code').innerText = "หมายเลขศูนย์บริการ: " + data.service_info.service_code;
                        document.getElementById('service-bus-stops').innerText = "ป้ายรถเมล์: " + data.service_info.bus_stops;
                        document.getElementById('service-opening-time').innerText = "เวลาเปิดทำการ: " + data.service_info.opening_time;

                    })
                    .catch(error => {
                        alert("เกิดข้อผิดพลาดในการดึงข้อมูล: " + error.message);
                    });

            },
            function (error) {
                alert("ไม่สามารถดึงข้อมูลตำแหน่งได้: " + error.message);
                console.log("Geolocation Error:", error);
            },
            {
                enableHighAccuracy: true,
                timeout: 10000,
                maximumAge: 0
            }
        );

        function reloadPage() {
            location.reload();
        }
    </script>

</body>

</html>